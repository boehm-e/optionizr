function retrieveAirBerlinFlightList(e,r,t,a,n,i,o,u,s,p,d){var f="_ajax[templates][]=dateoverview&_ajax[templates][]=main&_ajax[templates][]=priceoverview&_ajax[templates][]=infos&_ajax[templates][]=flightinfo&_ajax[requestParams][departure]="+a+"&_ajax[requestParams][destination]="+n+"&_ajax[requestParams][returnDeparture]=&_ajax[requestParams][returnDestination]=&_ajax[requestParams][outboundDate]="+i+"&_ajax[requestParams][returnDate]="+i+"&_ajax[requestParams][adultCount]="+u+"&_ajax[requestParams][childCount]="+s+"&_ajax[requestParams][infantCount]="+p+"&_ajax[requestParams][openDateOverview]=&_ajax[requestParams][oneway]="+d,l={url:"https://www.airberlin.com/fr-FR/booking/flight/vacancy.php?sid="+r,body:f,headers:{"Content-Type":"application/x-www-form-urlencoded","User-agent":"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0",Cookie:t,Referer:"https://www.airberlin.com/fr-FR/booking/flight/vacancy.php?sid="+r},cookieString:t};request.post(l,function(r,t,a){var n=JSON.parse(t.body),i=n.templates.main,t=parseData(i);e.send(t)})}function parseData(e){var r=e;console.log(e);for(var t,a=/<tr class="(flightrow|flightrow selected)">([^`]*?)<\/tr>/g,n=[];t=a.exec(r);)n.push(t[0]);console.log("SIZE : "+n.length);var o={};o.outbound={},o["return"]={};var u=0,s=0;for(i in n){var p=flightType(n[i].toString());"outbound"==p?(o.outbound[u]=flightInformations(n[i]),u++):"return"==p&&(o["return"][s]=flightInformations(n[i]),s++)}return orderObject(o)}function testOutbound(e,r,t,a,n){var i;for(i in n.outbound[t].faretype)if(n.outbound[t].faretype[i]==r[a])return n.outbound[t].prices[i];return"-"}function testReturn(e,r,t,a,n){var i;for(i in n["return"][t].faretype)if(n["return"][t].faretype[i]==r[a])return n["return"][t].prices[i];return"-"}function orderObject(e){console.log(JSON.stringify(e));for(var r=e,t=["BASE","EASY","COMF","PREM"],a={},n={},i=0;void 0!=r.outbound[i];i++){a[i]=[];var o;for(j in t)a[i].push(testOutbound(o,t,i,j,r))}for(var i=0;void 0!=r["return"][i];i++){n[i]=[];var o;for(j in t)n[i].push(testReturn(o,t,i,j,r))}for(i=0;void 0!=e.outbound[i];i++)e.outbound[i].prices=a[i];for(i=0;void 0!=e["return"][i];i++)e["return"][i].prices=n[i];return e}function flightInformations(e){var r,t={};t.prices=[];for(var a=/<span id="price-.{13}">(.{0,10})<\/span>/g,n=0;r=a.exec(e);)isOdd(n)||t.prices.push(r[1]),n++;t.time=[];for(var a=/<time>(.{3,10})<\/time>/g,n=0;r=a.exec(e);)t.time.push(r[1]),n++;t.stop=[];for(var a=/<td>(.{1})<\/td>/g,n=0;r=a.exec(e);)t.stop.push(r[1]),n++;t.flightid=[];for(var a=/<input type="hidden" name="flightid" value="([^`]*?)"\/>/g,n=0;r=a.exec(e);)t.flightid.push(r[1]),n++;t.fareindex=[];for(var a=/<input type="hidden" name="flightdetailsreference" value="([^`]*?)"\/>/g,n=0;r=a.exec(e);)t.fareindex.push(r[1]),n++;t.fareindex=[];for(var a=/<input type="hidden" name="faregroup" value="([^`]*?)"\/>/g,n=0;r=a.exec(e);)t.fareindex.push(r[1]),n++;t.faretype=[];for(var a=/<input type="hidden" name="faretype" value="([^`]*?)"\/>/g,n=0;r=a.exec(e);)t.faretype.push(r[1]),n++;return t}function isOdd(e){return e%2}function flightType(e){for(var r,t=/(outboundFareId)/g,a=[];r=t.exec(e);)a.push(r[0]);for(var r,t=/(returnFareId)/g,n=[];r=t.exec(e);)n.push(r[0]);return a.length>0?"outbound":n.lengt>0?"return":"fail"}function buildCookieString(e){var r="";if(!e)return"";for(var t=!0,a=0;a<e.length;a++){var n=e[a],i=n.split(";");i&&i.length>=1&&(t||(r+=" "),r+=i[0]+";",t=!1)}return r}function isOdd(e){return e%2}function flightType(e){for(var r,t=/(outboundFareId)/g;r=t.exec(e);)return"outbound";for(var r,t=/(returnFareId)/g;r=t.exec(e);)return"return";return"fail"}function buildCookie(e){var r="";if(!e)return"";for(var t=!0,a=0;a<e.length;a++){var n=e[a].toString(),i=n.split(";");i&&i.length>=1&&(t||(r+=" "),r+=i[0]+";",t=!1)}return r}var request=require("request"),requestt=require("request-sync"),requestSync=require("request-sync"),cookieJar=request.jar(),express=require("express"),app=express(),fs=require("fs"),req=require("request"),https=require("https"),getPicture=require("google-image-search-url-results"),cookieJar=request.jar(),optionizr=require("./optionizr_modules/optionizr.js");app.engine("ejs",require("ejs").renderFile),app.set("view engine","ejs"),app.get("/picture/:depart/:destination",function(e,r){var t=e.param("depart"),a=e.param("destination");r.send(getPicture(t,a))}),app.get("/departure",function(e,r){r.send(optionizr.buildArrayDeparture())}),app.get("/destination/:destination",function(e,r){var t=e.param("destination");r.send(optionizr.buildArrayDestination(t))}),app.get("/getsid/:departure/:destination/:outbounddate/:returndate/:adultcount/:childcount/:infantcount/:destletter/:departletter/:oneway",function(e,r){var t=e.param("departure"),a=e.param("destination"),n=e.param("outbounddate"),i=e.param("returndate"),o=e.param("adultcount"),u=e.param("childcount"),s=e.param("infantcount"),p=(e.param("destletter"),e.param("departletter"),e.param("oneway"));"true"==p?(p="1",i=n):p="";var d=requestt("https://www.airberlin.com/fr-FR/booking/flight/vacancy.php?departure="+t+"&destination="+a+"&outboundDate="+n+"&returnDate="+n+"&oneway="+p+"&openDateOverview=0&adultCount="+o+"&childCount=0&infantCount=0",{method:"GET"}),f=d.headers.location,l=new RegExp(/sid=(.{20})/),c=f.match(l),g=buildCookieString(d.headers["set-cookie"]);retrieveAirBerlinFlightList(r,c[1],g,t,a,n,i,o,u,s,p)}),app.get("/",function(e,r){r.end(fs.readFileSync("./views/index.ejs","utf-8"))}),app.listen(3e3,function(){console.log("listening on port 3000")});
